[project]
name = "rayforge"
version = "0.1.0"
channels = ["conda-forge", "bioconda", "msys2", "coastline"]
platforms = ["linux-64", "osx-64", "win-64"]

[environments]
default = { features = ["test"], solve-group = "default" }
windows-build = { features = ["windows-build", "test"], solve-group = "default" }
docs = { features = ["docs"], solve-group = "default" }

[dependencies]
adwaita-icon-theme = "*"
glib = "*"
cairo = "*"
expat = "*"
gettext = "*"
gobject-introspection = "*"
gtk4 = "*"
libheif = "*"
openslide = "*"
poppler = "*"
python = ">=3.11"
librsvg = ">=2.58.4,<3"
svgelements = ">=1.9.6,<2"

[build-dependencies]
pkg-config = "*"

[pypi-dependencies]
rayforge = { editable = true, path = "." }
aiohttp = "==3.12.14"
blinker = "==1.9.0"
build = "*"
ezdxf = "==1.3.5"
platformdirs = "==4.3.6"
pyclipper = "==1.3.0.post6"
PyGObject = "==3.50.0"
PyOpenGL = "==3.1.9"
PyOpenGL-accelerate = "==3.1.9"
pypdf = "==6.0.0"
pyserial-asyncio = "==0.6"
pyvips = "==3.0.0"
PyYAML = "==6.0.2"
scipy = "==1.15.2"
vtracer = "==0.6.11"
websockets = "==14.2"

[target.linux-64.dependencies]
libvips = "*"
xorg-xproto = "*"
xorg-libx11 = "*"
xorg-kbproto = "*"
xorg-xextproto = "*"
xorg-xineramaproto = "*"
xorg-xf86vidmodeproto = "*"
xorg-renderproto = "*"
xorg-inputproto = "*"
xorg-compositeproto = "*"
xorg-damageproto = "*"
xorg-glproto = "*"
xorg-presentproto = "*"
xorg-libxext = "*"
xorg-libxinerama = "*"
xorg-libxrandr = "*"

[target.osx-64.dependencies]
libvips = "*"

[target.win-64.dependencies]
# libvips is handled by MSYS2, so no dependency here

[feature.test.dependencies]
pytest = "*"

[feature.test.pypi-dependencies]
pytest-asyncio = "*"
pytest-mock = "*"
pytest-cov = "*"
pygobject-stubs = "*"
flake8 = "*"


[feature.docs.dependencies]
go = "*"
nodejs = "*"

[feature.docs.pypi-dependencies]
mkdocs-material = ">=9.5"
mkdocs-glightbox = "*"
mike = ">=2.0"
pillow = "*"
cairosvg = "*"
hugo = "*"

[feature.windows-build.dependencies]
pyinstaller = "*"

[tool.pixi]
workdir = "."

[tasks]
lint = "flake8 --ignore=E127,E128,E121,E123,E126,E203,E226,E24,E704,W503,W504 --builtins=_ rayforge"
update-translations = "bash scripts/update_translations.sh"
compile-translations = "bash scripts/update_translations.sh --compile-only"

[tasks.rayforge]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "scripts/with_gdk.sh rayforge"

[tasks.test]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "pytest -v"

[tasks.screenshot]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "scripts/with_gdk.sh scripts/take_screenshot.py"

[tasks.wheel]
cmd = "python3 -m build"
depends-on = ["compile-translations"]

[tasks.build-exe]
cmd = """
bash -c '
  set -e
  VERSION=${1:-"dev"}
  echo "Building version: $VERSION"
  
  # The MSYS2_PREFIX env var will be set by the GHA workflow
  MSYS_DIR=${MSYS2_PREFIX}
  echo "Using MSYS2 prefix: $MSYS_DIR"

  # We use pixi only to get the path to its own environment
  PIXI_PREFIX=$(pixi info -e windows-build --prefix)

  pyinstaller --onefile --noconsole \\
    --log-level INFO \\
    --name "rayforge-${VERSION}" \\
    --add-data "rayforge/resources;rayforge/resources" \\
    --add-data "rayforge/locale;rayforge/locale" \\
    --add-data "${MSYS_DIR}/share/glib-2.0/schemas;glib-2.0/schemas" \\
    --add-data "${MSYS_DIR}/share/icons;share/icons" \\
    --add-data "${MSYS_DIR}/lib/girepository-1.0;gi/repository" \\
    --add-binary "${MSYS_DIR}/bin/libEGL.dll;." \\
    --add-binary "${MSYS_DIR}/bin/libGLESv2.dll;." \\
    --add-binary "${MSYS_DIR}/bin/libvips-42.dll;." \\
    --hidden-import gi._gi_cairo \\
    rayforge/app.py
'
"""

[tasks.build-deb]
# Builds a binary .deb package for local installation and testing.
cmd = "bash scripts/build-deb.sh"
depends-on = ["compile-translations"]

[tasks.build-deb-source]
# Builds a source package, ready for upload to a PPA.
cmd = "bash scripts/build-deb.sh --source"
depends-on = ["compile-translations"]

# Tasks for developing and generating the website
[tasks.site-serve]
cmd = "pixi run -e docs _site-serve"

[tasks.site-build]
cmd = "pixi run -e docs _site-build"

# Internal docs tasks (called by the wrapper tasks above)
[feature.docs.tasks._site-serve]
cmd = "mkdocs serve --livereload --watch-theme"

[feature.docs.tasks._site-build]
cmd = "mkdocs build --strict --clean"

